name: Sync Classroom Data Only

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      classroom_name:
        description: 'GitHub Classroom name'
        required: true
        default: 'B4OS-Dev-2025'
      assignment_id:
        description: 'Specific assignment ID (optional)'
        required: false

jobs:
  sync-classroom:
    uses: ./.github/workflows/sync-workflow.yml
    with:
      classroom_name: ${{ inputs.classroom_name || 'B4OS-Dev-2025' }}
      assignment_id: ${{ inputs.assignment_id || '' }}
      log_level: 'INFO'
    secrets: inherit

  # Job 2: Comment on PR (if triggered by PR)
  comment-pr:
    runs-on: ubuntu-latest
    needs: sync-classroom
    if: github.event_name == 'pull_request'
    name: Comment on PR
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download sync logs
      uses: actions/download-artifact@v3
      with:
        name: sync-logs-${{ github.run_number }}-${{ inputs.classroom_name || 'B4OS-Dev-2025' }}
        path: logs/
    
    - name: Comment on PR
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Check if logs exist
          const logsPath = 'logs';
          if (fs.existsSync(logsPath)) {
            const logFiles = fs.readdirSync(logsPath);
            if (logFiles.length > 0) {
              const logContent = fs.readFileSync(path.join(logsPath, logFiles[0]), 'utf8');
              const lastLines = logContent.split('\n').slice(-20).join('\n');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Classroom Sync Results\n\n\`\`\`\n${lastLines}\n\`\`\``
              });
            }
          }
